#!/bin/sh

BRANCH=${1:-autosave}
SUSPEND=0

echo "  About to watch"
echo "    please have inotifywait and git..."
echo ""

checkout () {
  git checkout -b ${1} 2> /dev/null
  git checkout ${1}
}

commit () {
  if [ $SUSPEND -eq 0 ]
  then
    git add .
    git commit --no-gpg-sign -m "auto-commit"
    git push origin ${BRANCH}
  fi
}

merge () {
  SUSPEND=1
  checkout master
  git merge $BRANCH
  checkout $BRANCH
<<<<<<< HEAD
=======
  SUSPEND=0
>>>>>>> autosave
}

checkout $BRANCH
commit


#inotifywait -m ./ -e CLOSE_WRITE -e CREATE |
(inotifywait -m ./ -e CLOSE_WRITE -e CREATE & cat) |
  while read path action file; do
    echo "$path" "$action" "$file"

    case $path in
      ":m")

          echo "MMM merging"
          merge
            ;;

         *)
          echo "CCC committing"
          commit
            ;;
    esac

  done

