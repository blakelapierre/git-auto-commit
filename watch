#!/bin/sh

BRANCH=${1:-autosave}
SUSPEND=0

echo "  About to watch"
echo "    please have inotifywait and git..."
echo ""

checkout () {
  git checkout -b ${1} 2> /dev/null
  git checkout ${1}
}

commit () {
  git add .
  git commit --no-gpg-sign -m "auto-commit"
  git push origin ${BRANCH}
}

merge () {
  checkout master
  git merge --no-gpg-sign $BRANCH
  git push origin master
  checkout $BRANCH
}

checkout $BRANCH
commit


#inotifywait -m ./ -e CLOSE_WRITE -e CREATE |
(inotifywait -m ./ -e CLOSE_WRITE -e CREATE & cat) |
  while read path action file; do
    echo "$path" "$action" "$file"

    case $path in
      ":m")

          echo "MMM merging"
          SUSPEND=1
          merge
          SUSPEND=0
            ;;

         *)
          if [ $SUSPEND -eq 0 ]
          then
            echo "CCC committing $SUSPEND"
            commit
          fi
            ;;
    esac

  done

